#!/bin/bash

# Đọc cấu hình từ file config.cnf
CONFIG_FILE="/etc/automysqlbackup/my-config.cnf"
if [ ! -f "$CONFIG_FILE" ]; then
  echo "Configuration file not found: $CONFIG_FILE"
  exit 1
fi

source "$CONFIG_FILE"

# Định nghĩa các biến phụ thuộc
DATE=$(date +%F)
DAY_OF_WEEK=$(date +%u)  # Ngày trong tuần (1 = Thứ 2, 7 = Chủ nhật)
export MYSQL_PWD=$MYSQL_PASSWORD

# Tạo thư mục sao lưu nếu chưa tồn tại
mkdir -p "$BACKUP_DIR/daily"
mkdir -p "$BACKUP_DIR/weekly"
mkdir -p "$BACKUP_DIR/monthly"

# Lấy danh sách database cần sao lưu
DATABASES=$(mysql -u$MYSQL_USER -e "SHOW DATABASES;" | grep -Ev "(Database|$CONFIG_DB_EXCLUDE)")

if [ -z "$DATABASES" ]; then
  echo "$(date +'%Y-%m-%d %H:%M:%S') - No databases found to backup." >>"$BACKUP_DIR/backup_log_$DATE.log"
  exit 1
fi

# Hàm thực hiện sao lưu
backup_database() {
  local backup_type=$1
  local backup_dir=$2

  for DB in $DATABASES; do
    BACKUP_FILE="$DATE"_"$DB.sql.gz"
    if mysqldump -u$MYSQL_USER $DB | gzip >"$backup_dir/$BACKUP_FILE"; then
      echo "$(date +'%Y-%m-%d %H:%M:%S') - Backup successful: $DB -> $BACKUP_FILE" >>"$BACKUP_DIR/backup_log_$DATE.log"
    else
      echo "$(date +'%Y-%m-%d %H:%M:%S') - Backup failed for database: $DB" >>"$BACKUP_DIR/backup_log_$DATE.log"
    fi
  done
}

# Gọi các hàm sao lưu
backup_database "daily" "$BACKUP_DIR/daily"
if [ "$DAY_OF_WEEK" -eq 1 ]; then
  backup_database "weekly" "$BACKUP_DIR/weekly"
fi

if [ "$DAY_OF_WEEK" -eq 1 ] && [ "$(date +%d)" -eq 01 ]; then
  backup_database "monthly" "$BACKUP_DIR/monthly"
fi

# Dọn dẹp bản sao lưu cũ
cleanup_old_backups() {
  find "$BACKUP_DIR/daily" -type f -mtime +30 -exec rm -f {} \;
  find "$BACKUP_DIR/weekly" -type f -mtime +84 -exec rm -f {} \;
  find "$BACKUP_DIR/monthly" -type f -mtime +365 -exec rm -f {} \;
}

cleanup_old_backups
echo "$(date +'%Y-%m-%d %H:%M:%S') - Cleanup completed." >>"$BACKUP_DIR/backup_log_$DATE.log"

# Tùy chọn gửi email (nếu được cấu hình)
if [ "$EMAIL_OPTION" != "no_email" ]; then
  BODY="MySQL Backup Log - $DATE\n$(cat "$BACKUP_DIR/backup_log_$DATE.log")"
  echo -e "$BODY" | mail -s "MySQL Backup Report - $DATE" -a "From: $SENDER_NAME <$EMAIL_FROM>" "$EMAIL_TO"
fi
